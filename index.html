<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>BAN-MD Ultimate QR Login</title>
<script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
<style>
  body { font-family: Arial; background: #0f172a; color: #e2e8f0; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; text-align: center; }
  h1 { color: #22c55e; }
  #qrcode, #sessionQR { margin-top: 20px; padding: 16px; background: white; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.3); }
  .connected { font-size: 1.4em; color: #22c55e; margin-top: 20px; font-weight: bold; }
  .disconnected { font-size: 1.2em; color: #f87171; margin-top: 20px; font-weight: bold; }
  button { margin-top: 20px; padding: 10px 20px; font-size: 1em; border-radius: 8px; border: none; background: #22c55e; color: white; cursor: pointer; }
  button:hover { background: #16a34a; }
</style>
</head>
<body>
<h1>ü§ñ BAN-MD Ultimate QR Login</h1>
<p id="instruction">Scan this QR code with your WhatsApp to connect</p>
<canvas id="qrcode"></canvas>
<p id="status"></p>

<h2>Session QR (scan for multi-login)</h2>
<canvas id="sessionQR" style="display:none;"></canvas>
<p id="sessionText"></p>

<button id="reconnectBtn">üîÑ Reconnect</button>

<script>
async function fetchStatus() {
  try {
    const res = await fetch("/status");
    const data = await res.json();
    const canvas = document.getElementById("qrcode");
    const instruction = document.getElementById("instruction");
    const status = document.getElementById("status");

    if (data.connected) {
      canvas.style.display = "none";
      instruction.style.display = "none";
      status.innerHTML = `‚úÖ <span class="connected">Connected as ${data.jid}</span>`;
      await fetchSessionQR(); // show session QR
      return true;
    } else {
      canvas.style.display = "block";
      instruction.style.display = "block";
      status.innerHTML = `<span class="disconnected">‚ùå Disconnected. Please scan a new QR.</span>`;
      document.getElementById("sessionQR").style.display = "none";
      document.getElementById("sessionText").innerHTML = "";
      return false;
    }
  } catch (err) {
    console.error("Status check failed", err);
    return false;
  }
}

async function fetchQR() {
  const status = document.getElementById("status");
  const canvas = document.getElementById("qrcode");

  const connected = await fetchStatus();
  if (connected) return;

  try {
    const res = await fetch("/qr");
    const data = await res.json();

    if (!data.ok) {
      status.innerHTML = "‚ùå " + data.message;
      return;
    }

    QRCode.toCanvas(canvas, data.qr, { width: 250 }, (err) => {
      if (err) console.error(err);
    });

    status.innerHTML = `‚úÖ QR ready. Expires in ${(data.ttl / 1000).toFixed(0)}s`;
  } catch (err) {
    status.innerHTML = "‚ö†Ô∏è Error fetching QR";
    console.error(err);
  }
}

// Fetch session QR
async function fetchSessionQR() {
  const canvas = document.getElementById("sessionQR");
  const sessionText = document.getElementById("sessionText");

  try {
    const res = await fetch("/session-qr");
    const data = await res.json();

    if (!data.ok) {
      canvas.style.display = "none";
      sessionText.innerHTML = "";
      return;
    }

    const img = new Image();
    img.src = data.qr;
    img.onload = () => {
      const ctx = canvas.getContext("2d");
      canvas.width = img.width;
      canvas.height = img.height;
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      ctx.drawImage(img, 0, 0);
      canvas.style.display = "block";
    };

    sessionText.innerHTML = `üìå Session ID: ${data.sessionId}`;
  } catch (err) {
    console.error("Failed to fetch session QR", err);
  }
}

// Reconnect button
document.getElementById("reconnectBtn").addEventListener("click", async () => {
  const status = document.getElementById("status");
  status.innerHTML = "üîÑ Reconnecting...";
  try {
    const res = await fetch("/reconnect", { method: "POST" });
    const data = await res.json();
    status.innerHTML = data.ok ? "‚ôªÔ∏è Reconnecting..." : "‚ùå Failed: " + data.error;
  } catch (err) {
    status.innerHTML = "‚ùå Error reconnecting";
    console.error(err);
  }
});

// Poll QR & status every 5s
setInterval(fetchQR, 5000);
fetchQR();
</script>
</body>
</html>
